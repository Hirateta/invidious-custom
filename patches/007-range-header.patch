From 502572edc7cb9119720a7d2bcc7c9c7a296c7875 Mon Sep 17 00:00:00 2001
From: Emilien Devos <4016501+unixfox@users.noreply.github.com>
Date: Sat, 26 Oct 2024 20:23:07 +0200
Subject: [PATCH 1/1] range query string post

---
 assets/js/player.js | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/assets/js/player.js b/assets/js/player.js
index 353a5296..d0bad747 100644
--- a/assets/js/player.js
+++ b/assets/js/player.js
@@ -42,6 +42,21 @@ embed_url = location.origin + '/embed/' + video_data.id + embed_url.search;
 var save_player_pos_key = 'save_player_pos';
 
 videojs.Vhs.xhr.beforeRequest = function(options) {
+    // send range in the query string and with POST method
+    // taken from Freetube:
+    // https://github.com/FreeTubeApp/FreeTube/blob/development/src/renderer/components/ft-shaka-video-player/ft-shaka-video-player.js#L1096
+    if (options.uri.includes("videoplayback")) {
+        options.method = 'POST'
+        options.body = new Uint8Array([0x78, 0]) // protobuf: { 15: 0 } (no idea what it means but this is what YouTube uses)
+
+        if (options.headers.Range) {
+            options.uri += `&range=${options.headers.Range.split('=')[1]}`
+            delete options.headers.Range
+        }
+
+        options.uri += '&alr=yes'
+    }
+
     // set local if requested not videoplayback
     if (!options.uri.includes('videoplayback')) {
         if (!options.uri.includes('local=true'))
-- 
2.47.0
